<script src="./js/nunjucks.js"></script>
<script src="./js/pollyjs-core.js"></script>
<script src="./js/pollyjs-adapter-fetch.js"></script>
<script src="./js/pollyjs-adapter-xhr.js"></script>
<script>
    const PollyJS = window['@pollyjs/core'];
    const FetchAdapter = window['@pollyjs/adapter-fetch']
    const XHRAdapter = window['@pollyjs/adapter-xhr']

    const { Polly } = PollyJS;

    Polly.register(FetchAdapter);
    Polly.register(XHRAdapter);

    const polly = new Polly('Simple Example', {
        adapters: ['fetch', 'xhr'],
        mode: "passthrough",
        logging: true,
    });

    const server = polly.server;
    const fileMap = {};

    function readFile(filename) {
        return fileMap[filename]
    }

    const on = {
        get: (route, handler) => {
            server.get(route).intercept(async (req, res) => {
                console.log(req);

                // var request = new Request(req.url, {
                // })

                var response = await handler(req)

                for (const [k,v] of response.headers.entries()) res.setHeader(k,v);
                
                res.status(response.status).send(await response.text());
                //    .setHeaders([...response.headers.entries()].reduce((map, obj) => {map[obj[0]] = obj[1]; return map;}, {}))

            });
        }
    }

    window.addEventListener('message', async (message) => {
        if (message.data == null || message.data.type != 'initialize_sandbox') return;
        
        message.data.files.forEach(file => {
            fileMap[file.filename] = file.contents
        });

        eval(readFile('server.js'))
            
        // let res = await fetch('/')
        // document.head.parentElement.innerHTML = await res.text()

        // let headers = {}
        // let tres = await fetch('/clicked')
        // console.log(tres);
        // console.log(await tres.text())
        // console.log([...tres.headers.entries()]);
        // console.log([...tres.headers.entries()].reduce((map, obj) => {map[obj[0]] = obj[1]; return map;}, {}));
    })

    // nunjucks.configure({ autoescape: true });
    // console.log(nunjucks.renderString('Hello {{ username }}', { username: 'James' }));


</script>